<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MegaChat Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    <style>
        body { font-family: sans-serif; background: #e5ddd5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #messages { list-style: none; padding: 20px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        #messages li { padding: 10px; border-radius: 10px; background: white; max-width: 70%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #messages li.my { background: #dcf8c6; align-self: flex-end; }
        
        .controls { display: flex; padding: 10px; background: #f0f0f0; gap: 8px; align-items: center; border-top: 1px solid #ccc; position: relative; }
        input#i { flex: 1; padding: 12px; border: none; border-radius: 20px; outline: none; font-size: 16px; }
        
        .btn { background: none; border: none; cursor: pointer; font-size: 24px; padding: 5px; }
        .send-btn { background: #25d366; color: white; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        
        .recording { color: red; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.3;} 100% {opacity: 1;} }
        
        #emoji-picker { position: absolute; bottom: 70px; left: 10px; display: none; z-index: 100; }
        img { max-width: 100%; border-radius: 5px; }
    </style>
</head>
<body>
    <ul id="messages"></ul>
    <div id="emoji-picker"></div>

    <form id="f" class="controls">
        <button type="button" class="btn" onclick="toggleEmoji()">😊</button>
        <input type="file" id="fi" style="display:none" accept="image/*">
        <button type="button" class="btn" onclick="document.getElementById('fi').click()">🖼️</button>
        <button type="button" id="rec-btn" class="btn">🎤</button>
        <input id="i" autocomplete="off" placeholder="Сообщение...">
        <button type="submit" class="send-btn">➤</button>
    </form>

    <script>
        const socket = io();
        const name = prompt("Ваше имя:") || "Аноним";
        let mediaRecorder;
        let audioChunks = [];
        let currentStream = null;

        // ЭМОДЗИ
        const picker = new EmojiMart.Picker({ 
            onEmojiSelect: (emoji) => { document.getElementById('i').value += emoji.native; }
        });
        document.getElementById('emoji-picker').appendChild(picker);
        function toggleEmoji() {
            const p = document.getElementById('emoji-picker');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        // ГОЛОСОВЫЕ (С ПОЛНОЙ ОСТАНОВКОЙ МИКРОФОНА)
        const recBtn = document.getElementById('rec-btn');
        recBtn.onclick = async () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                // ПОЛУЧАЕМ ДОСТУП ПРИ НАЧАЛЕ
                currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(currentStream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        socket.emit('chat message', { user: name, file: reader.result, type: 'audio' });
                    };
                    // ОТКЛЮЧАЕМ МИКРОФОН В КОНЦЕ
                    currentStream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                recBtn.classList.add('recording');
                recBtn.innerText = "🛑";
            } else {
                // ОСТАНАВЛИВАЕМ ЗАПИСЬ
                mediaRecorder.stop();
                recBtn.classList.remove('recording');
                recBtn.innerText = "🎤";
            }
        };

        function addMsg(data) {
            const li = document.createElement('li');
            if (data.user === name) li.className = 'my';
            let content = `<b>${data.user}</b><br>${data.text || ''}`;
            if (data.file) {
                if (data.type === 'image') content += `<br><img src="${data.file}">`;
                if (data.type === 'audio') content += `<br><audio controls src="${data.file}"></audio>`;
            }
            li.innerHTML = content;
            document.getElementById('messages').appendChild(li);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        document.getElementById('f').onsubmit = (e) => {
            e.preventDefault();
            const i = document.getElementById('i');
            const file = document.getElementById('fi').files[0];
            if (file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    socket.emit('chat message', { user: name, text: i.value, file: reader.result, type: 'image' });
                    document.getElementById('fi').value = '';
                };
            } else if (i.value) {
                socket.emit('chat message', { user: name, text: i.value });
            }
            i.value = '';
            document.getElementById('emoji-picker').style.display = 'none';
        };

        socket.on('chat message', d => addMsg(d));
    </script>
</body>
</html>