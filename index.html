<!DOCTYPE html>
<html>
<head>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>MegaChat Pro v5.2</title>
    <style>
        body { font-family: sans-serif; background: #d1e8ff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; list-style: none; margin: 0; }
        li { max-width: 75%; padding: 10px; border-radius: 15px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
        .my-msg { align-self: flex-end; background: #ffeb3b; }
        img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        audio { max-width: 100%; margin-top: 5px; display: block; }
        #typing-monitor { padding: 5px 20px; font-size: 0.8em; color: #555; font-style: italic; height: 20px; }
        form { background: #fff; padding: 10px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; }
        input[id='input'] { flex-grow: 1; border-radius: 20px; border: 1px solid #ddd; padding: 10px; outline: none; }
        button { background: #0084ff; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; user-select: none; }
        .file-btn { background: #676767; }
        .voice-btn { background: #f44336; transition: 0.2s; }
        .voice-btn.recording { transform: scale(1.2); background: #ff0000; box-shadow: 0 0 10px rgba(255,0,0,0.5); }
    </style>
</head>
<body>
    <ul id='messages'></ul>
    <div id='typing-monitor'></div>
    <form id='form'>
        <input type='file' id='file-input' style='display:none'>
        <button type='button' class='file-btn' onclick="document.getElementById('file-input').click()">📎</button>
        <button type='button' id='voice-btn' class='voice-btn'>🎤</button>
        <input id='input' type="text" autocomplete='off' placeholder='Сообщение...' />
        <button type='submit'>➤</button>
    </form>

    <script src='/socket.io/socket.io.js'></script>
    <script>
        const socket = io();
        const myName = prompt('Имя:') || 'Гость';
        socket.emit('set username', myName);

        if (Notification.permission !== 'granted') Notification.requestPermission();

        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        const fileInput = document.getElementById('file-input');
        const voiceBtn = document.getElementById('voice-btn');
        
        let mediaRecorder;
        let audioChunks = [];
        let activeStream = null;

        function addMsg(data) {
            const item = document.createElement('li');
            if (data.user === myName) item.classList.add('my-msg');
            let content = `<b>${data.user}</b>: ${data.text || ''}`;
            if (data.file) {
                if (data.file.startsWith('data:image')) content += `<br><img src="${data.file}" onclick="window.open(this.src)">`;
                else if (data.file.startsWith('data:audio')) content += `<br><audio controls src="${data.file}"></audio>`;
                else content += `<br><a href="${data.file}" download="${data.fileName}">📥 Скачать: ${data.fileName}</a>`;
            }
            item.innerHTML = content;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
            if (Notification.permission === 'granted' && document.hidden && data.user !== myName) {
                new Notification(`От ${data.user}`, { body: data.text || "Прислал файл/ГС" });
            }
        }

        // Логика файлов (исправленная)
        fileInput.onchange = () => {
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                socket.emit('chat message', { user: myName, text: `📁 Файл: ${file.name}`, file: e.target.result, fileName: file.name });
            };
            reader.readAsDataURL(file);
            fileInput.value = ''; 
        };

        // --- УЛУЧШЕННАЯ ЛОГИКА ГС (ВКЛЮЧЕНИЕ ПО НАЖАТИЮ) ---
        async function startRecording() {
            try {
                audioChunks = [];
                activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(activeStream);
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        socket.emit('chat message', { user: myName, text: '🎤 Голосовое сообщение', file: e.target.result, fileName: 'voice.webm' });
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    // ПОЛНОЕ ВЫКЛЮЧЕНИЕ МИКРОФОНА
                    activeStream.getTracks().forEach(track => track.stop());
                    activeStream = null;
                };

                mediaRecorder.start();
                voiceBtn.classList.add('recording');
            } catch (err) {
                alert("Ошибка доступа к микрофону: " + err);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                voiceBtn.classList.remove('recording');
            }
        }

        voiceBtn.onmousedown = startRecording;
        voiceBtn.onmouseup = stopRecording;
        
        // Для телефонов
        voiceBtn.ontouchstart = (e) => { e.preventDefault(); startRecording(); };
        voiceBtn.ontouchend = (e) => { e.preventDefault(); stopRecording(); };

        socket.on('chat history', h => h.forEach(addMsg));
        socket.on('chat message', addMsg);

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            if (input.value.trim()) {
                socket.emit('chat message', { user: myName, text: input.value });
                input.value = '';
            }
        };
    </script>
</body>
</html>